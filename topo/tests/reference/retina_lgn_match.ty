"""
For matching with C++ lissom's retina_lgn_match.param.

$Id$
"""
__version__='$Revision$'


### CEBHACKALERT: the comparisons in this file will not work
### until it is updated.


## With one GeneratorSheet connected to one CFSheet via Disk-shaped
## weights, presenting a Gaussian input pattern:
##
## topo retinal activity sum (time 1):
## 2.80077196557051e+01
## c++ eye00 activity sum (time 1):
## 2.80077222131501e+01
##
## topo 'LGN' activity sum (time 1):
## 2.33881340462627e+01
## c++ Ganglia00 activity sum (time 1):
## 2.33881275592545e+01


import fixedpoint

from math import pi, sqrt
from fixedpoint import FixedPoint

from topo.sheets.generatorsheet import GeneratorSheet
from topo.projections.basic import SharedWeightCFProjection
import topo.patterns.basic
from topo.base.sheet import BoundingBox
from topo.base.parameterclasses import DynamicNumber
from topo.base.cf import CFSheet
from topo.base.boundingregion import BoundingBox
from topo.base.parameterclasses import Wrapper
from topo.outputfns.basic import PiecewiseLinear,IdentityOF,DivisiveNormalizeL1
from topo.responsefns.optimized import CFPRF_SharedWeightDotProduct_opt

from topo.tests.reference.lissom_log_parser import get_input_params, get_matrix, compare_elements

fixedpoint.DEFAULT_PRECISION=3

BaseN=48.0

BaseRN=24.0
rf_radius=BaseRN/4.0+0.5
area_scale=1.0
randomness = 0.0
xsigma=6.0
ysigma=1.5
scale_input=1.0
sigma_c = 4.5 # for 'LGN' Disk of diameter 9 
r_L = 5.5 # for 11x11 ConnectionField
lgn_edge_buffer = round(rf_radius,0)
retina_edge_buffer=round(rf_radius+r_L,0)
RN=round(BaseRN*area_scale+2*retina_edge_buffer,0)
LN=round(BaseRN*area_scale+2*lgn_edge_buffer,0)


GeneratorSheet.nominal_density = BaseRN*area_scale
GeneratorSheet.period = 1
GeneratorSheet.phase=0.05

# take the input pattern position parameters from the log
# file output of the equivalent c++ simulation
n_inputs,input_x,input_y,input_orientation = get_input_params(log_file="topo/tests/reference/oo_or_map_topo.log")
n_inputs-=1;input_x.next();input_y.next();input_orientation.next() # c++ lissom's first iteration is just a test
print "Number of patterns available for learning iterations:",n_inputs
gaussian_width = xsigma/BaseRN/sqrt(2.0)
gaussian_height = ysigma/BaseRN/sqrt(2.0)

input_pattern = topo.patterns.basic.Gaussian(scale=scale_input,
                                             size = 2*gaussian_height,
                                             aspect_ratio= gaussian_width/gaussian_height,
                                             x=DynamicNumber(lambda : input_x.next()/BaseRN - 0.5*LN/BaseRN),
                                             y=DynamicNumber(lambda : input_y.next()/BaseRN - 0.5*LN/BaseRN),
                                             orientation=DynamicNumber(lambda : round(2*pi*input_orientation.next()/360.0,1)))


retina_bounds = BoundingBox(radius= RN/(2.0*BaseRN*area_scale))
lgn_bounds = BoundingBox(radius=LN/(2.0*BaseRN*area_scale))
                                               
# Connection parameters
lgn_weight_bounds = BoundingBox(radius=r_L/BaseRN)

# Circular ConnectionFields
CFProjection.weights_shape = topo.patterns.basic.Disk(smoothing=0.0)
SharedWeightCFProjection.response_fn=CFPRF_SharedWeightDotProduct_opt()
SharedWeightCFProjection.weights_output_fn.single_cf_fn=IdentityOF() #DivisiveNormalizeL1()


topo.sim['Retina'] = GeneratorSheet(nominal_bounds=retina_bounds,
                                    input_generator=input_pattern)

topo.sim['LGNOn'] = CFSheet(nominal_bounds=lgn_bounds,nominal_density=BaseRN,
                      output_fn=PiecewiseLinear(lower_bound=0.0,upper_bound=1.0))

## topo.sim['LGNOff'] = CFSheet(nominal_bounds=lgn_bounds,nominal_density=BaseRN,
##                       output_fn=PiecewiseLinear(lower_bound=0.0,upper_bound=1.0))


lgn_weight_pattern = topo.patterns.basic.Disk(smoothing=0.0,
    size=2*sigma_c/BaseRN,aspect_ratio=1,output_fn=DivisiveNormalizeL1())


# LGN ON channel
topo.sim.connect('Retina','LGNOn',delay=FixedPoint("0.05"),
                  connection_type=SharedWeightCFProjection,strength=1.0,
                  nominal_bounds_template=lgn_weight_bounds,
                  weights_generator=lgn_weight_pattern)

## # LGN OFF channel
## topo.sim.connect('Retina','LGNOff',delay = FixedPoint("0.05"),
##                   connection_type=SharedWeightCFProjection,strength=1.0,
##                   nominal_bounds_template=lgn_weight_bounds,
##                   weights_generator=lgn_weight_pattern)



# This is the command used to generate the C++ data 
# (set commandpath to the location of your lissom command/ directory)
# ./lissom5 commandpath="../../../../lissom_old/command/" display=0 retina_lgn_match.param -c "call set_thresholds.command" -c "ppm_weight_scale_type=PPM_WtScale_Fixed" -c "Region::ppm_weight_fixed_multiplier=1" -c 'PlotGroup::Weights::filename_format="$$$${filebase}.$$$${06iteration}.wts.$$$${current_region}.$$$${current_plot}.$$$${03current_ui}_$$$${03current_uj}"' -c "cmd::plot_unit::weight_situate=False" -c "plot_unit region=Ganglia00 save_matrices=True" -c "step" -c 'plot filename_format=$$$${default_filename_format} save_matrices=True'

topo.sim.run(1)
    

# no. of decimal places for matching activity and weight values
act_dp = 5
wt_dp = 5

# compare C++ LISSOM and Topograhica activity values in the Retina/Eye00:
c_eye00_act = get_matrix("topo/tests/reference/retina_lgn_match.000001p000.Eye0_Activity.matrix",(RN,RN))
compare_elements(topo.sim['Retina'].activity,c_eye00_act,act_dp,"Retina")

# compare C++ LISSOM and Topograhica activity values in the 'LGN':
c_ganglia00_act = get_matrix("topo/tests/reference/retina_lgn_match.000001p000.Ganglia00_Activity.matrix",(LN,LN))
compare_elements(topo.sim['LGNOn'].activity,c_ganglia00_act,act_dp,"LGNOn")

# compare C++ LISSOM and Topographica weights:

# CEBHACKALERT: turning off situate in c++ lissom appears to make the
# weight plot unsituated but leaves the matrix output situated. So it's
# necessary to take the right slice from the BaseNxBaseN matrix.

# Retina-LGN
i,j=18,18
topo_LGNOn_weights = topo.sim['LGNOn'].in_connections[0].cf(i,j).weights
c_Ganglia00_afferent = get_matrix('topo/tests/reference/retina_lgn_match.000000.wts.Ganglia00.Afferent0.018_018.matrix',(BaseN,BaseN)) 
c_Ganglia00_afferent = c_Ganglia00_afferent[18:29,18:29]

compare_elements(topo_LGNOn_weights,c_Ganglia00_afferent,wt_dp,"LGNOn weights")
